import React, { Component } from 'react';
import rpc from 'utils/rpc';
import images from 'utils/images';

type State = typeof initialState;

const initialState = {
	inVehicle: false,
	engine: {
		health: 100,
		active: false,
	},
	velocity: 0,
	rpm: 0,
	fuel: {
		current: 0,
		max: 100,
	},
	locked: false,
	seatbelt: false,
	cruise: false,
};

export default class Speedometer extends Component<{}, State> {
	readonly state: State = initialState;

	componentDidMount() {
		rpc.register('Speedometer-UpdateState', (state: State) => this.setState(() => state));
	}

	componentWillUnmount() {
		rpc.unregister('Speedometer-UpdateState');
	}

	render() {
		const { inVehicle, engine, velocity, rpm, fuel, cruise, locked, seatbelt } = this.state;

		let barFuelsCount = 0;

		if (fuel?.current > 0) {
			barFuelsCount = Math.floor((fuel.current / fuel.max) * 5);
		}

		const timestamp = Date.now();
		const blink = Math.floor(timestamp / 500) % 2 === 0;

		return (
			inVehicle && (
				<div className="ares_hud_speedo">
					<div>
						<Speedo speed={velocity.toString().padStart(3, '0')} />
						<p className="speedo_label">km/h</p>
					</div>
					<div className="speedo_icons">
						<div className="speedo_left">
							<div className="speedo_icon">
								<svg
									width="19"
									height="13"
									viewBox="0 0 19 13"
									fill="none"
									xmlns="http://www.w3.org/2000/svg"
								>
									<path
										d="M5.54199 0.166748V1.75008H7.91699V3.33341H5.54199L3.95866 4.91675V7.29175H2.37533V4.91675H0.791992V11.2501H2.37533V8.87508H3.95866V11.2501H6.33366L7.91699 12.8334H14.2503V9.66675H15.8337V12.0417H18.2087V4.12508H15.8337V6.50008H14.2503V3.33341H9.50033V1.75008H11.8753V0.166748H5.54199Z"
										fill={engine.health < 10 && blink ? '#FFA800' : '#E0E0E6'}
									/>
								</svg>
							</div>
							<div className="speedo_icon">
								<svg
									width="19"
									height="18"
									viewBox="0 0 19 18"
									fill="none"
									xmlns="http://www.w3.org/2000/svg"
								>
									<path
										d="M19 12.1244C19 14.5492 17.86 16.6943 16.055 18L15.58 17.5337L13.585 15.5751L14.915 14.2694L16.055 15.3886C16.53 14.7358 16.91 13.8964 17.005 13.057H15.2V11.1917H17.005C16.815 10.3523 16.53 9.60622 16.055 8.8601L14.915 9.97927L13.585 8.67358L14.725 7.5544C14.06 7.08808 13.205 6.71503 12.35 6.62176V8.39378H10.45V6.62176C9.595 6.80829 8.835 7.08808 8.075 7.5544L10.925 10.3523C11.115 10.3523 11.21 10.2591 11.4 10.2591C11.9039 10.2591 12.3872 10.4556 12.7435 10.8054C13.0998 11.1552 13.3 11.6296 13.3 12.1244C13.3 12.6191 13.0998 13.0935 12.7435 13.4433C12.3872 13.7931 11.9039 13.9896 11.4 13.9896C10.8961 13.9896 10.4128 13.7931 10.0565 13.4433C9.70018 13.0935 9.5 12.6191 9.5 12.1244C9.5 11.9378 9.5 11.8446 9.595 11.658L6.745 8.8601C6.27 9.51295 5.89 10.3523 5.795 11.1917H7.6V13.057H5.795C5.985 13.8964 6.27 14.6425 6.745 15.3886L7.885 14.2694L9.215 15.5751L6.745 18C4.94 16.6943 3.8 14.5492 3.8 12.1244C3.8 10.1455 4.60071 8.24776 6.02599 6.84853C7.45126 5.44929 9.38435 4.66321 11.4 4.66321C13.4156 4.66321 15.3487 5.44929 16.774 6.84853C18.1993 8.24776 19 10.1455 19 12.1244ZM4.465 3.07772L1.33 0L0 1.3057L3.135 4.38342L1.9 5.59586H5.7V1.86529L4.465 3.07772Z"
										fill={cruise ? '#C4FF07' : '#E0E0E6'}
									/>
								</svg>
							</div>
							<div className="speedo_icon">
								<svg
									width="12"
									height="15"
									viewBox="0 0 12 15"
									fill="none"
									xmlns="http://www.w3.org/2000/svg"
								>
									<path
										d="M1.41667 14.875C1.02708 14.875 0.693694 14.7364 0.4165 14.4592C0.139305 14.182 0.000472222 13.8484 0 13.4583V6.375C0 5.98542 0.138833 5.65203 0.4165 5.37483C0.694167 5.09764 1.02756 4.95881 1.41667 4.95833H2.125V3.54167C2.125 2.56181 2.47043 1.72668 3.16129 1.03629C3.85215 0.345903 4.68728 0.000472222 5.66667 0C6.64653 0 7.48189 0.345431 8.17275 1.03629C8.86361 1.72715 9.20881 2.56228 9.20833 3.54167V4.95833H9.91667C10.3062 4.95833 10.6399 5.09717 10.9175 5.37483C11.1952 5.6525 11.3338 5.98589 11.3333 6.375V13.4583C11.3333 13.8479 11.1947 14.1815 10.9175 14.4592C10.6403 14.7369 10.3067 14.8755 9.91667 14.875H1.41667ZM5.66667 11.3333C6.05625 11.3333 6.38987 11.1947 6.66754 10.9175C6.94521 10.6403 7.08381 10.3067 7.08333 9.91667C7.08333 9.52708 6.94474 9.19369 6.66754 8.9165C6.39035 8.63931 6.05672 8.50047 5.66667 8.5C5.27708 8.5 4.94369 8.63883 4.6665 8.9165C4.38931 9.19417 4.25047 9.52756 4.25 9.91667C4.25 10.3062 4.38883 10.6399 4.6665 10.9175C4.94417 11.1952 5.27756 11.3338 5.66667 11.3333ZM3.54167 4.95833H7.79167V3.54167C7.79167 2.95139 7.58507 2.44965 7.17187 2.03646C6.75868 1.62326 6.25694 1.41667 5.66667 1.41667C5.07639 1.41667 4.57465 1.62326 4.16146 2.03646C3.74826 2.44965 3.54167 2.95139 3.54167 3.54167V4.95833Z"
										fill={locked ? '#FF4C4C' : '#E0E0E6'}
									/>
								</svg>
							</div>
						</div>
						<div className="speedo_right">
							<div className="speedo_icon">
								<svg
									width="15"
									height="17"
									viewBox="0 0 15 17"
									fill="none"
									xmlns="http://www.w3.org/2000/svg"
								>
									<path
										d="M7.4565 0C7.91801 0 8.36062 0.179107 8.68696 0.497918C9.0133 0.81673 9.19664 1.24913 9.19664 1.7C9.19664 2.6435 8.42227 3.4 7.4565 3.4C6.99498 3.4 6.55237 3.22089 6.22603 2.90208C5.89969 2.58327 5.71636 2.15087 5.71636 1.7C5.71636 1.24913 5.89969 0.81673 6.22603 0.497918C6.55237 0.179107 6.99498 0 7.4565 0ZM7.79582 10.8715C9.03176 10.8668 10.2668 10.9378 11.4936 11.084C11.5458 8.772 11.337 6.732 10.9368 5.95C10.8237 5.7205 10.6671 5.525 10.5017 5.355L3.48028 11.237C4.66357 11.05 6.15139 10.8715 7.79582 10.8715ZM3.50638 12.75C3.61949 14.229 3.84571 15.725 4.21114 17H6.01218C5.75986 16.252 5.57715 15.3765 5.43794 14.45C5.43794 14.45 7.4565 14.076 9.47506 14.45C9.33585 15.3765 9.15313 16.252 8.90081 17H10.7019C11.0847 15.6825 11.3109 14.1185 11.424 12.5715C10.2201 12.4293 9.0085 12.3583 7.79582 12.359C6.11659 12.359 4.65487 12.5375 3.50638 12.75ZM7.4565 4.25C7.4565 4.25 4.84629 4.25 3.97622 5.95C3.68039 6.528 3.48898 7.7775 3.42807 9.316L9.12703 4.539C8.26566 4.25 7.4565 4.25 7.4565 4.25ZM13.1729 3.1195L12.181 1.989L9.12703 4.5475C9.60557 4.709 10.1102 4.964 10.5017 5.355L13.1729 3.1195ZM15 11.7555C14.9217 11.73 13.6688 11.3305 11.4936 11.084C11.4849 11.5685 11.4588 12.07 11.424 12.5715C13.3817 12.8095 14.5041 13.175 14.5215 13.175L15 11.7555ZM3.42807 9.316L0 12.189L0.774362 13.447C0.791763 13.4385 1.80104 13.056 3.50638 12.75C3.41067 11.5515 3.38457 10.37 3.42807 9.316Z"
										fill={!seatbelt && blink ? '#E0E0E6' : '#FF4C4C'}
									/>
								</svg>
							</div>
							<div className="fuel">
								<SpeedoIcon icon="hud_fuel.svg" />
								<div className="fuel_bar">
									{Array.from({ length: 5 }).map((_, index) => (
										<div
											key={index}
											className={`fuel_bar_item ${
												index <= barFuelsCount ? 'fuel_bar_green' : ''
											}`}
										/>
									))}
								</div>
							</div>
						</div>
					</div>
				</div>
			)
		);
	}
}

interface SpeedoProps {
	speed: string;
}

const Speedo = ({ speed }: SpeedoProps) => {
	return (
		<div className="speed">
			<div className="speedo_char">
				<p>{speed}</p>
			</div>
		</div>
	);
};

const SpeedoIcon = ({ icon, activeClass = '' }: { icon: string; activeClass?: string }) => {
	return (
		<div className={`speedo_icon ${activeClass}`}>
			<img src={images.getImage(icon)} />
		</div>
	);
};
